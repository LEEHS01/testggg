USE [HNS_DP]
GO
/****** Object:  StoredProcedure [dbo].[GET_ALARM_YEARLY]    Script Date: 2025-10-22 오후 4:33:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GET_ALARM_YEARLY]
AS
BEGIN
SELECT 
    AREANM, 
    ISNULL([0], 0) AS ALA0, 
    ISNULL([1], 0) AS ALA1, 
    ISNULL([2], 0) AS ALA2
FROM (
    SELECT OBS.AREANM, ALA.ALACODE
    FROM (
        SELECT AREA.AREANM, OBS.OBSNM, AREA.AREATYPE, OBS.OBSIDX 
        FROM dbo.TB_AREA AS AREA 
        JOIN dbo.TB_OBS AS OBS ON AREA.AREAIDX = OBS.AREAIDX
    ) AS OBS
    LEFT JOIN dbo.TB_ALARM_DATA AS ALA 
        ON OBS.OBSIDX = ALA.OBSIDX 
        AND YEAR(ALA.ALADT) = YEAR(GETDATE())
) AS SourceTable
PIVOT (
    COUNT(ALACODE) 
    FOR ALACODE IN ([0], [1], [2])
) AS PivotTable
ORDER BY ISNULL([0], 0) + ISNULL([1], 0) + ISNULL([2], 0) DESC
END