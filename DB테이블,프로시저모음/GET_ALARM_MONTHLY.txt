USE [HNS_DP]
GO
/****** Object:  StoredProcedure [dbo].[GET_ALARM_MONTHLY]    Script Date: 2025-10-22 오후 4:34:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GET_ALARM_MONTHLY]
AS
BEGIN
SELECT 
    OBS.AREANM,
    ISNULL(COUNT(ALA.ALACODE), 0) AS CNT
FROM (
    SELECT AREA.AREANM, OBS.OBSNM, AREA.AREATYPE, OBS.OBSIDX 
    FROM dbo.TB_AREA AS AREA 
    JOIN dbo.TB_OBS AS OBS ON AREA.AREAIDX = OBS.AREAIDX
) AS OBS
LEFT JOIN dbo.TB_ALARM_DATA AS ALA 
    ON OBS.OBSIDX = ALA.OBSIDX
    AND ALA.ALADT >= DATEFROMPARTS(YEAR(GETDATE()), MONTH(GETDATE()), 1)
    AND ALA.ALADT < DATEADD(MONTH, 1, DATEFROMPARTS(YEAR(GETDATE()), MONTH(GETDATE()), 1))
GROUP BY OBS.AREANM 
ORDER BY CNT DESC
END